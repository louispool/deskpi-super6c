# Role definition for installing [OpenSearch](https://opensearch.org/), a distributed search and analytics engine.

```
├── roles
│  ├── opensearch-install
|  |  ├── defaults
|  |  |  ├── main.yml
|  |  ├── tasks 
|  |  |  ├── main.yml  
|  |  ├── templates
|  |  |  ├── opensearch-admin-cert.yml.j2
|  |  |  ├── opensearch-helm-values.yml.j2
|  |  |  ├── opensearch-rest-api.yml.j2
|  |  |  ├── opensearch-security-config-secret.yml.j2
|  |  |  ├── opensearch-transport-cert.yml.j2
```

## About

OpenSearch is a distributed search and analytics engine based on Apache Lucene, an opensource fork of Elasticsearch and Kibana following the license change in early 2021. 

OpenSearch enables full-text searches on ingested data with features such as: 
- Searching by Field 
- Searching multiple Indexes 
- Field Boosting 
- Ranking results by Score
- Sorting results by Field 
- Result Aggregation

In the context of the DeskPi Cluster, OpenSearch is used to index and search the logs generated by the various services running on the cluster.

## Synopsis

This role does the following:
1. If configured, taints nodes for OpenSearch to repel general workloads and reserve those nodes for OpenSearch.
2. Creates a namespace for the OpenSearch deployment.
3. Deploys the [OpenSearch Helm chart](https://docs.opensearch.org/docs/latest/install-and-configure/install-opensearch/helm/) with values that specify:
   - the OpenSearch cluster name and node group
   - the OpenSearch version to install
   - certificates for the OpenSearch Transport Layer, Rest API and cluster administration
   - the OpenSearch cluster size (i.e. number of replicas)
   - the OpenSearch resource limits and requests
   - the OpenSearch PVC size and storage class
4. Configures the Certificates for the OpenSearch REST API and Transport Layer.
5. Exposes the OpenSearch REST API via an IngressRoute on the local network

## Configuration

Configure the namespace for the Opensearch deployment via the variable `k3s_opensearch_namespace`:
```yaml
k3s_opensearch_namespace: opensearch
```
     
Configure the [version](https://docs.opensearch.org/docs/latest/version-history/) of OpenSearch to install via the 
- `opensearch_chart_version` for the Helm chart version, and
- `opensearch_app_version` for the OpenSearch Docker image version.
```yaml
opensearch_chart_version: "2.34.0"
opensearch_app_version: "2.9.0"
```
See the [note](#note-on-the-version-of-opensearch) on the version of OpenSearch below.

Configure the name and group name of the OpenSearch cluster via the variables `opensearch_cluster_name` and `opensearch_node_group` respectively:
```yaml
opensearch_cluster_name: "opensearch-cluster"
opensearch_node_group: "master"
```
From these variables Kubernetes will create resources named like:
```shell
opensearch-cluster-master-0
svc/opensearch-cluster-master
``` 

The following configuration properties taints the specified nodes in your cluster to repel general workloads and reserve those nodes for OpenSearch, and compels the scheduler to schedule the OpenSearch
pods onto only the specified nodes.
```yaml
opensearch_nodes:
  - deskpi2
  - deskpi3
  - deskpi4
  
opensearch_enable_node_tolerations: true
```

Configure the size of the OpenSearch cluster (i.e. number of instances/pods - each scheduled on a separate node) via the variable `opensearch_replicas`:
```yaml
opensearch_replicas: 3
```

The following configuration properties define the resource requirements of the OpenSearch pods. Consider the limitations of your hardware - note that the 
[OpenSearch Requirements](https://github.com/opensearch-project/helm-charts/tree/main/charts/opensearch#requirements) recommends 8GB of memory per pod, or at minimum 4GB of memory, otherwise the deployment will fail.
```yaml
opensearch_resources_limits_memory: "5Gi"
opensearch_resources_limits_cpu: "2000m"

opensearch_resources_requests_memory: "2Gi"
opensearch_resources_requests_cpu: "1000m"
```
                                                                                                                                                       
Configure the size of the Persistent Volume Claim (PVC) for OpenSearch data storage via the variable `opensearch_pvc_size` and the storage class via `opensearch_storage_class`:
```yaml
opensearch_pvc_size: "30Gi"
opensearch_storage_class: "longhorn"
```

Define the internal endpoint for the OpenSearch REST API via the variable `opensearch_rest_api`:
```yaml
opensearch_rest_api: "api.opensearch.localnet"
```

Define the endpoint to the OpenSearch Dashboard via the variable `opensearch_dashboard`:
```yaml
opensearch_dashboard: "dashboard.opensearch.localnet"
```

Define the endpoint to the public Grafana Dashboard via the variable `public_opensearch_dashboard`:
```yaml
public_opensearch_dashboard: dashboard.opensearch.example.com
```

Configure whether to enable the public Opensearch Dashboard via the variable `enable_public_opensearch_dashboard`:
```yaml
enable_public_opensearch_dashboard: true
```

Define the usernames for the OpenSearch users:
```yaml
opensearch_admin_user: "admin"
opensearch_dashboards_admin_user: "kibanaserver"
opensearch_dashboards_user: "kibanaro"
opensearch_logger_user: "logger"
opensearch_monitoring_user: "monitor"
opensearch_snapshot_restore_user: "snapshotrestore"
```
Define the passwords for the OpenSearch users:
```yaml
opensearch_admin_passwd: "!s3cr3t"
opensearch_dashboards_admin_passwd: "!s3cr3t"
opensearch_dashboards_user_passwd: "!s3cr3t"
opensearch_logger_passwd: "!s3cr3t"
opensearch_monitoring_passwd: "!s3cr3t"
opensearch_snapshot_restore_passwd: "!s3cr3t"                
```
*Note that these should be overridden by a vault variable.*

Whether to enable prometheus monitoring via plugin. **Important**, the exporter plugin must match the version of OpenSearch.
```yaml
opensearch_enable_monitoring: false
```
   
### Note on the version of OpenSearch

The latest Opensearch image is built on Amazon Linux 23, which requires an **ARMv8.2-A** CPU or newer with cryptographic extensions. 

Raspberry Pi CM4/CM5 are **ARMv8-A**, but they do not implement **all** of **ARMv8.2-A**, especially the cryptographic instructions required by 
Amazon Linux 2023. 

This is why the init container crashes immediately when using the latest OpenSearch image on a Raspberry Pi CM4/CM5.

### [Security Configuration](https://docs.opensearch.org/docs/latest/security/configuration/yaml/)

The YAML configuration files necessary for the OpenSearch Security plugin is defined in [opensearch-security-config-secret.yml.j2](templates/opensearch-security-config-secret.yml.j2) template.
These include the files:

- `config.yml`
- `internal_users.yml`
- `roles.yml`
- `roles_mapping.yml`
- `tenants.yml`
- `action_groups.yml`

If you wish to customize the security configuration you should edit the template file directly.

By default, the OpenSearch HELM installation will utilize a demo configuration for the security plugin, which is suitable for testing and development purposes.
We override the default demo configuration with a custom configuration derived from the [template](templates/opensearch-security-config-secret.yml.j2) mentioned above.

To view the files as used in the demo configuration, see the [OpenSearch Security GitHub](https://github.com/opensearch-project/security/tree/main/config).
Take care not to override static roles, action groups, tenants etc. They are reserved by the plugin and their definitions can be
found [here](https://github.com/opensearch-project/security/tree/main/src/main/resources/static_config).
  
## Testing

After the role has been executed, you can verify the Opensearch deployment by checking the pods' READY state in the `opensearch` namespace:
```shell
kubectl -n opensearch get pods 
```

Expected output (example):
```shell
NAME                          READY   STATUS    RESTARTS   AGE
opensearch-cluster-master-0   1/1     Running   0          61m
opensearch-cluster-master-1   1/1     Running   0          61m
opensearch-cluster-master-2   1/1     Running   0          61m
```

Ideally, you would check the health of the Opensearch cluster by querying the REST API endpoint, which is exposed via an IngressRoute on the local network (in the example assumed to be *deskpi.localnet*).
```shell
curl -u admin https://opensearch.deskpi.localnet/_cluster/health?pretty
```
Expected output (example):
```json
{
   "cluster_name": "opensearch-cluster",
   "status": "green",
   "timed_out": false,
   "number_of_nodes": 3,
   "number_of_data_nodes": 3,
   "discovered_master": true,
   "discovered_cluster_manager": true,
   "active_primary_shards": 5,
   "active_shards": 12,
   "relocating_shards": 0,
   "initializing_shards": 0,
   "unassigned_shards": 0,
   "delayed_unassigned_shards": 0,
   "number_of_pending_tasks": 0,
   "number_of_in_flight_fetch": 0,
   "task_max_waiting_in_queue_millis": 0,
   "active_shards_percent_as_number": 100.0
}
```
Look for the `status` field to be `green`, which indicates that the cluster is healthy and all primary and replica shards are allocated.

If the Ingress is failing for some reason, you can also access the REST API directly via the pod itself
```shell
kubectl -n opensearch exec -ti opensearch-cluster-master-0 -- curl -k -u admin http://localhost:9200/_cluster/health?pretty
```
Note that in the case above we are using http instead of https, as we are accessing the REST API directly from within the pod.

You can also check for errors in the logs of an OpenSearch pod:
```shell
kubectl -n opensearch logs opensearch-cluster-master-0
```

## securityadmin.sh

`securityadmin.sh` is a CLI utility bundled with OpenSearch that pushes security configuration files (e.g., internal_users.yml, roles.yml, etc.) directly into the OpenSearch cluster, via the transport
layer (not HTTP/REST).

It's the only official way to initialize or reset the OpenSearch security index `.opendistro_security` from static YAML files.

On the official docker image it is located at `/usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh`.

It is used when
 - Bootstrapping (initial config when the Helm chart or static secret doesn't load it)
 - Re-uploading config files manually (e.g., after changing a YAML file outside the Helm chart)
 - Troubleshooting or recovering a broken `.opendistro_security` index

It is not required if your Helm deployment already sets up the opensearch-security-config-secret with the securityConfig block (*which is done by this role*).

But if you ever want to push new security files without a Helm redeploy, this is your tool.

To use it you need to run the `securityadmin.sh` script from within the OpenSearch pod, with the correct parameters.
```bash
kubectl -n opensearch exec -ti opensearch-cluster-master-0 -- bash

# Inside the pod
cd /usr/share/opensearch/plugins/opensearch-security/tools

# Push config from mounted secret
./securityadmin.sh \
  -cd /usr/share/opensearch/config/opensearch-security \
  -icl \
  -nhnv \
  -cacert /usr/share/opensearch/config/transport-certs/ca.crt \
  -cert /usr/share/opensearch/config/admin-certs/tls.crt \
  -key /usr/share/opensearch/config/admin-certs/tls.key
```
where 
- cd: Config directory with the security YAMLs
- icl: Ignore cluster name mismatch
- nhnv: No hostname verification
- cacert, -cert, -key: TLS client auth via the admin certificate

Alternatively you can create a job or standalone pod to run the `securityadmin.sh` script, which is useful for automation or CI/CD pipelines.
```yml
apiVersion: batch/v1
kind: Job
metadata:
   name: push-security-config
   namespace: opensearch
spec:
   template:
      spec:
         containers:
            - name: push
              image: opensearchproject/opensearch:2.9.0
              command:
                 - bash
                 - -c
                 - |
                    cd /usr/share/opensearch/plugins/opensearch-security/tools
                    ./securityadmin.sh \
                      -cd /usr/share/opensearch/config/opensearch-security \
                      -icl -nhnv \
                      -cacert /usr/share/opensearch/config/transport-certs/ca.crt \
                      -cert /usr/share/opensearch/config/admin-certs/tls.crt \
                      -key /usr/share/opensearch/config/admin-certs/tls.key
              volumeMounts:
                 - name: security-config
                   mountPath: /usr/share/opensearch/config/opensearch-security
                 - name: transport-tls
                   mountPath: /usr/share/opensearch/config/transport-certs
                 - name: admin-tls
                   mountPath: /usr/share/opensearch/config/admin-certs
         volumes:
            - name: security-config
              secret:
                 secretName: opensearch-security-config-secret
            - name: transport-tls
              secret:
                 secretName: opensearch-transport-cert-secret
            - name: admin-tls
              secret:
                 secretName: opensearch-admin-secret
         restartPolicy: Never
```


