# Role definition for installing the [OpenSearch Dashboards](https://docs.opensearch.org/docs/latest/dashboards/)

```
├── roles
│  ├── opensearch-dashboards-install
|  |  ├── defaults
|  |  |  ├── main.yml
|  |  ├── tasks 
|  |  |  ├── main.yml  
|  |  ├── templates
|  |  |  ├── opensearch-dashboards-helm-values.yml.j2
```

## About

OpenSearch Dashboards is an open-source data visualization tool designed to work with OpenSearch, providing a UI for exploring and analyzing data within a single OpenSearch domain. 
OpenSearch Dashboards is derived from Kibana 7.10.2. 

When Elastic switched to a more restrictive license for Kibana, the OpenSearch project forked Kibana 7.10.2 to create OpenSearch Dashboards, which
is released under the Apache 2.0 license, allowing for more open-source freedom

In the context of the DeskPi Cluster, OpenSearch is used to index and search the logs generated by the various services running on the cluster.

**Note**: this role is designed to be used in conjunction with the [OpenSearch Install](../opensearch-install) role, which installs the OpenSearch server.

## Synopsis

This role assumes the following:
   - A namespace for the OpenSearch deployment is created.
   - The OpenSearch server is installed and running and the OpenSearch REST API is accessible via the property `opensearch_rest_api`.

This role does the following:

1. Checks the namespace `k3s_opensearch_namespace` exists and fails if it does not.
2. Deploys the [OpenSearch Dashboards Helm chart](https://docs.opensearch.org/docs/latest/install-and-configure/install-dashboards/helm/) with values that specify:
   - the OpenSearch Dashboards version to install
   - the OpenSearch Dashboards resource limits and requests
   - the OpenSearch server to connect to (via the property `opensearch_rest_api`)
   - the credentials to connect to the OpenSearch server (via the property `opensearch_dashboards_admin_passwd`)
3. Exposes the OpenSearch Dashboards via:
    - an IngressRoute on the local network
    - an IngressRoute on the internet (if `enable_public_opensearch_dashboard` is set to `true`).

## Configuration

Configure the namespace for the Opensearch deployment via the variable `k3s_opensearch_namespace`:
```yaml
k3s_opensearch_namespace: opensearch
```

Configure the [version](https://docs.opensearch.org/docs/latest/version-history/) of OpenSearch Dashboards to install
```yaml
opensearch_app_version: "2.9.0"
```
See the [note](../opensearch-install/README.md#note-on-the-version-of-opensearch) on the version of OpenSearch.

Configure the name and group name of the OpenSearch cluster via the variables `opensearch_cluster_name` and `opensearch_node_group` respectively:
```yaml
opensearch_cluster_name: "opensearch-cluster"
opensearch_node_group: "master"
```
   

From these variables Kubernetes will create resources named like:

```shell
opensearch-cluster-master-0
svc/opensearch-cluster-master
``` 

The following configuration properties taints the specified nodes in your cluster to repel general workloads and reserve those nodes for OpenSearch, and compels the scheduler to schedule the
OpenSearch
pods onto only the specified nodes.

```yaml
opensearch_nodes:
  - deskpi2
  - deskpi3
  - deskpi4
  
opensearch_enable_node_tolerations: true
```

Configure the size of the OpenSearch cluster (i.e. number of instances/pods - each scheduled on a separate node) via the variable `opensearch_replicas`:

```yaml
opensearch_replicas: 3
```

The following configuration properties define the resource requirements of the OpenSearch pods. Consider the limitations of your hardware - note that the
[OpenSearch Requirements](https://github.com/opensearch-project/helm-charts/tree/main/charts/opensearch#requirements) recommends 8GB of memory per pod, or at minimum 4GB of memory, otherwise the
deployment will fail.

```yaml
opensearch_resources_limits_memory: "5Gi"
opensearch_resources_limits_cpu: "2000m"

opensearch_resources_requests_memory: "2Gi"
opensearch_resources_requests_cpu: "1000m"
```

Configure the size of the Persistent Volume Claim (PVC) for OpenSearch data storage via the variable `opensearch_pvc_size` and the storage class via `opensearch_storage_class`:

```yaml
opensearch_pvc_size: "30Gi"
opensearch_storage_class: "longhorn"
```

Define the internal endpoint for the OpenSearch REST API via the variable `opensearch_rest_api`:

```yaml
opensearch_rest_api: "api.opensearch.localnet"
```

Define the endpoint to the OpenSearch Dashboard via the variable `opensearch_dashboard`:

```yaml
opensearch_dashboard: "dashboard.opensearch.localnet"
```

Define the endpoint to the public Grafana Dashboard via the variable `public_opensearch_dashboard`:

```yaml
public_opensearch_dashboard: dashboard.opensearch.example.com
```

Configure whether to enable the public Opensearch Dashboard via the variable `enable_public_opensearch_dashboard`:

```yaml
enable_public_opensearch_dashboard: true
```

Defines the password for the OpenSearch admin user. The password is required, without it installation will fail.

```yaml
opensearch_admin_passwd: "!s3cr3t"
```

*Note that this should be overridden by a vault variable.*

Whether to enable prometheus monitoring via plugin. **Important**, the exporter plugin must match the version of OpenSearch.

```yaml
opensearch_enable_monitoring: false
```